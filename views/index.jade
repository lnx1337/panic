extends layout
block content
  #map  
  #encabezado
      h3 NOOSBIT RESEARCH NETWORKS
  #seccion1
     .area_media
        .usuarios
          img.foto(src='kike.png', alt='foto_perfil',id="foto")
          .nombre Alejandro León Vega
          #coordenadas2 20.385825,-99.404297
     .area_media  
   
  #seccion2
      #area_entera  
  #mapdos  
  #menu
      .boton
        img(src='/images/uno.png', alt='')
      .boton
        img(src='/images/dos.png', alt='')
      .boton
        img(src='/images/tres.png', alt='')
      .boton
        img(src='/images/cuatro.png', alt='')
      .boton
        img(src='/images/cinco.png', alt='')
  #coordenadas 20.385825,-99.404297

  script
      var map = L.mapbox.map('mapdos', 'lnx1337.map-eu8sxqx2');
      var mapdos = L.mapbox.map('map', 'lnx1337.map-eu8sxqx2');
      mapdos.setView([19.43267,-99.133269], 5);
      function addMarker(json){
          var f=json;
          var tam =f.length;
          var i=0;
          var geoJson=new Array();

          for(i=0;i<tam;i++){
            geoJson[i]={type: 'Feature',"geometry": { "type": "Point", "coordinates": [f[i].longitude,f[i].latitude]},"properties": {  "abonado_id":f[i].abonado_id,"description":f[i].mediaDescription ,"image": "/uploads/"+f[i].name+".png" ,"url": "http://en.wikipedia.org/wiki/Washington,_D.C.","marker-symbol": "star","city": f[i].descriptionAlert }}; 
          }

          map.markerLayer.on('layeradd', function(e) {
                  var marker = e.layer,
                      feature = marker.feature;
                      
                  var popupContent =  '<h1>'+feature.properties.description+'</h1><a target="_blank" class="popup" href="' + feature.properties.url + '">' +
                                          '<img src="' + feature.properties.image + '">' +
                                      '   <h2>' + feature.properties.city + '</h2>' +
                                      '</a>';
                  marker.bindPopup(popupContent,{
                      closeButton: false,
                      minWidth: 120
                  });
          });

          map.markerLayer.setGeoJSON(geoJson);
           

        }

       addMarker(!{JSON.stringify(data)});
       map.setView([19.43267,-99.133269], 5);
       
       map.markerLayer.on('click', function(e) {     
          
       mapdos.setView(e.layer.getLatLng(), 16);
                L.mapbox.markerLayer({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [e.layer.getLatLng().lng , e.layer.getLatLng().lat]
                    },
                    properties: {
                        title: '',
                        description: 'Ubicación',
                        'marker-size': 'large',
                    }
        }).addTo(mapdos);

           $.ajax({
                          type: "GET",
                          url: "/abonado/"+e.layer.feature.properties['abonado_id'],
                          data: "",
                          success: function(datos){
                            $(".usuarios").html("<img src=\"/uploads/"+datos[0].name+".png\"  class=\"foto\" ><div class=\"nombre\" > Nombre:"+ datos[0].name+" "+datos[0].FirstName+"</div><hr width=\"100%\"/>Medio:"+datos[0].mediaDescription+"<br><hr width=\"100%\"/>Tipo Alerta: "+datos[0].descriptionAlert+"<br><hr width=\"100%\"/>Coordenadas: lat:"+datos[0].latitude+" lng:"+datos[0].longitude+"<br><hr width=\"100%\"/>Dispositivo:Iphone 5"+"<br><hr width=\"100%\"/>Carrier:"+"Telcel");
    
                          }
                  }); 
       });

        
              var socket  = io.connect('http://lnx1337.cloudapp.net');
              socket.on('conectado', function(data) {
                      console.log("conectado"+data);
              });
              socket.on('refresh', function(data) {
                  addMarker(JSON.parse(data));     
             
              });
          

  div(id="content",class="element information")


          


    
   
   
